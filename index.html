<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pixel Math Worksheet Generator</title>
<style>
  :root { --ui-bg:#111; --ui-fg:#eee; --accent:#4ad; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif; background:#0b0b0b; color:var(--ui-fg); }
  header { padding:16px 18px 8px; }
  h1 { margin:0 0 10px; font-size:20px; letter-spacing:.2px; }

  #controls {
    display:grid; gap:10px;
    grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    padding:0 18px 14px;
  }
  .card { background:var(--ui-bg); border:1px solid #1f1f1f; border-radius:10px; padding:14px; }
  .label { font-size:12px; color:#bbb; margin-bottom:6px; }
  input[type="number"]{
    width:100%; padding:8px 10px; border-radius:8px;
    border:1px solid #222; background:#181818; color:var(--ui-fg);
  }
  button{
    appearance:none; border:1px solid #233; border-radius:10px;
    padding:10px 12px; background:#17212b; color:#e9f4ff; cursor:pointer; font-weight:600;
  }
  button:hover{ filter:brightness(1.08); }
  button.secondary{ background:#1a1a1a; color:#ddd; border-color:#2a2a2a; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .grow{ flex:1 1 auto; }

  #drop{
    border:2px dashed #2b2b2b; border-radius:12px; padding:18px; text-align:center;
    background:#121212; color:#ccc; transition:border-color .15s ease, background .15s ease; cursor:pointer;
  }
  #drop.drag{ border-color:var(--accent); background:#0e1620; color:#e3f2ff; }

  #previews{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); padding:0 18px 18px; }
  canvas.preview, img.preview{
    width:100%; background:#101010; border-radius:8px; border:1px solid #222; display:block;
  }
  .note{ color:#aaa; font-size:12px; margin-top:6px; }

  @media print {
    body { background:#fff; }
    header, #controls, #previews { display:none !important; }
    #printWrap { display:block !important; }
    @page { size:auto; margin:12mm; }
  }
  #printWrap { display:none; }
  #printWrap img { width:100%; height:auto; display:block; }
  .page-break { break-before:page; page-break-before:always; }
</style>
</head>
<body>
  <header>
    <h1>Pixel Math Worksheet Generator</h1>
  </header>

  <section id="controls">
    <div class="card">
      <div id="drop">
        <strong>Drop an image here</strong><br/>or click to choose
        <input id="file" type="file" accept="image/*" style="display:none" />
      </div>
      <div class="note">Tip: square/compact images work best for larger grids.</div>
    </div>

    <div class="card">
      <div class="row">
        <div class="grow">
          <div class="label">Number of pixels across</div>
          <input id="cols" type="number" min="4" max="96" step="1" value="24" />
        </div>
        <div class="grow">
          <div class="label">Number of pixels down</div>
          <input id="rows" type="number" min="4" max="96" step="1" value="24" />
        </div>
      </div>
      <div class="row">
        <div class="grow">
          <div class="label">Number of colors to use</div>
          <input id="kcolors" type="number" min="2" max="12" step="1" value="6" />
        </div>
      </div>

      <div class="card" id="answersCard" style="display:none">
        <div class="label">Answer Value for Each Color</div>
        <div id="answersContainer"></div>
      </div>

      <div class="row">
        <div class="grow">
          <div class="label">Font Size</div>
          <input id="fontScale" type="number" min="6" max="48" step="1" value="18" />
        </div>
      </div>

      <div class="row">
        <button id="btnPixelate" class="grow">Pixelate</button>
        <button id="btnGenerate" class="grow">Generate</button>
      </div>

      <div class="row" style="margin-top:4px;">
        <label style="display:flex;align-items:center;gap:6px;">
          <input id="includeAnswerKey" type="checkbox" checked />
          Include Answer Key in PDF
        </label>
      </div>

      <div class="row">
        <button id="btnSave" class="grow secondary">Save PDF</button>
      </div>
      <div class="note">“Save PDF” opens the print dialog; choose “Save as PDF”.</div>
    </div>

    <div class="card">
      <div class="label">Original (fit)</div>
      <canvas id="origCanvas" class="preview"></canvas>
    </div>

    <div class="card">
      <div class="label">Pixelated preview</div>
      <canvas id="pixCanvas" class="preview"></canvas>
      <div class="note">Click “Generate” to see worksheet and answer previews.</div>
    </div>

    <div class="card">
      <div class="label">Worksheet preview (used for PDF page 1)</div>
      <img id="worksheetPreview" class="preview" alt="worksheet preview"/>
    </div>

    <div class="card">
      <div class="label">Answer key preview (used for PDF page 2)</div>
      <img id="answerPreview" class="preview" alt="answer preview"/>
    </div>
  </section>

  <section id="printWrap">
    <img id="worksheetPrint" alt="worksheet print image"/>
    <img id="answerPrint" class="page-break" alt="answer print image"/>
  </section>

<script>
(() => {
  let img = new Image();
  let imgLoaded = false;

  const colsEl = document.getElementById('cols');
  const rowsEl = document.getElementById('rows');
  const kEl    = document.getElementById('kcolors');
  const includeAnswerKeyEl = document.getElementById('includeAnswerKey');

  const origCanvas = document.getElementById('origCanvas');
  const pixCanvas  = document.getElementById('pixCanvas');
  const octx = origCanvas.getContext('2d');
  const pctx = pixCanvas.getContext('2d');

  const worksheetPreviewImg = document.getElementById('worksheetPreview');
  const answerPreviewImg    = document.getElementById('answerPreview');
  const worksheetPrintImg   = document.getElementById('worksheetPrint');
  const answerPrintImg      = document.getElementById('answerPrint');

  let gridW=0, gridH=0;
  let cellColors = []; 
  let palette = [];    
  let indices = [];   
  let problems = [];  

  function clamp(v,a,b){return Math.max(a,Math.min(b,v|0));}
  const rgbToHex = (r,g,b)=>'#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');

  function drawOrigFit(){
    if(!imgLoaded){octx.clearRect(0,0,origCanvas.width,origCanvas.height);return;}
    const maxW=600;
    const scale=Math.min(1,maxW/img.width);
    origCanvas.width=Math.round(img.width*scale);
    origCanvas.height=Math.round(img.height*scale);
    octx.imageSmoothingEnabled=true;
    octx.clearRect(0,0,origCanvas.width,origCanvas.height);
    octx.drawImage(img,0,0,origCanvas.width,origCanvas.height);
  }

  function sampleToGrid(w,h){
    gridW=clamp(w,4,256);
    gridH=clamp(h,4,256);
    const tmp=document.createElement('canvas');
    tmp.width=img.width; tmp.height=img.height;
    const tctx=tmp.getContext('2d');
    tctx.drawImage(img,0,0);
    const data=tctx.getImageData(0,0,img.width,img.height).data;
    cellColors=new Array(gridW*gridH);
    const stepX=img.width/gridW;
    const stepY=img.height/gridH;
    for(let y=0;y<gridH;y++){
      for(let x=0;x<gridW;x++){
        const cx=Math.floor((x+0.5)*stepX);
        const cy=Math.floor((y+0.5)*stepY);
        const idx=(cy*img.width+cx)*4;
        const r=data[idx],g=data[idx+1],b=data[idx+2];
        cellColors[y*gridW+x]={r,g,b};
      }
    }
  }

  // K-means quantization for colors
  function kmeansQuantize(k){
    if(!cellColors.length)return;
    // initialize palette with random pixels
    palette=cellColors.slice(0,k).map(p=>({...p}));
    let changed=true, iter=0;
    const maxIter=20;
    const assign=new Array(cellColors.length);
    while(changed && iter<maxIter){
      changed=false;
      for(let i=0;i<cellColors.length;i++){
        let best=0,bd=Infinity;
        for(let j=0;j<k;j++){
          const d=(cellColors[i].r-palette[j].r)**2+(cellColors[i].g-palette[j].g)**2+(cellColors[i].b-palette[j].b)**2;
          if(d<bd){bd=d;best=j;}
        }
        if(assign[i]!==best){assign[i]=best; changed=true;}
      }
      // recalc centroids
      const sums=new Array(k).fill(0).map(()=>({r:0,g:0,b:0,count:0}));
      for(let i=0;i<cellColors.length;i++){
        const a=assign[i];
        sums[a].r+=cellColors[i].r;
        sums[a].g+=cellColors[i].g;
        sums[a].b+=cellColors[i].b;
        sums[a].count++;
      }
      for(let j=0;j<k;j++){
        if(sums[j].count>0){
          palette[j].r=Math.round(sums[j].r/sums[j].count);
          palette[j].g=Math.round(sums[j].g/sums[j].count);
          palette[j].b=Math.round(sums[j].b/sums[j].count);
        }
      }
      iter++;
    }
    palette=palette.map(p=>({...p,hex:rgbToHex(p.r,p.g,p.b)}));
    indices=assign;
  }

  function drawPixelatedPreview(){
    if(!cellColors.length||!palette.length||!indices.length)return;
    const scale=20;
    pixCanvas.width=gridW;
    pixCanvas.height=gridH;
    pctx.clearRect(0,0,pixCanvas.width,pixCanvas.height);
    for(let y=0;y<gridH;y++){
      for(let x=0;x<gridW;x++){
        const idx=y*gridW+x;
        pctx.fillStyle=palette[indices[idx]].hex;
        pctx.fillRect(x,y,1,1);
      }
    }
    pixCanvas.style.width=(gridW*scale)+'px';
    pixCanvas.style.height=(gridH*scale)+'px';
  }

  function makeProblem(answerNum){
    if(Math.random()<0.5){
      let a=Math.floor(Math.random()*(answerNum+1));
      let b=answerNum-a;
      if(a===0&&answerNum>1&&Math.random()<0.6){a=1;b=answerNum-1;}
      return `${a}+${b}`;
    } else {
      let span=10+Math.floor(Math.random()*6);
      let a=answerNum+Math.floor(Math.random()*span);
      if(a>30)a=30;
      let b=a-answerNum;
      return `${a}-${b}`;
    }
  }

  function renderWorksheetCanvas(){
    const PAGE_W=1800,MARGIN=60,TITLE_H=64;
    const ND_H=40,ND_GAP=20,KEY_SWATCH=28,KEY_CELL_W=96,KEY_ROW_GAP=12;
    const itemsPerRow=Math.max(1,Math.floor((PAGE_W-2*MARGIN)/KEY_CELL_W));
    const keyRows=Math.ceil(palette.length/itemsPerRow);
    const KEY_BLOCK_H=keyRows*(KEY_SWATCH+KEY_ROW_GAP)+6;
    let cell=Math.max(16,Math.floor((PAGE_W-2*MARGIN)/gridW));
    const gridDrawW=cell*gridW;
    const gridDrawH=cell*gridH;
    const PAGE_H=MARGIN+TITLE_H+ND_H+ND_GAP+KEY_BLOCK_H+20+gridDrawH+MARGIN;

    const c=document.createElement('canvas');
    c.width=PAGE_W;c.height=PAGE_H;
    const ctx=c.getContext('2d');
    ctx.fillStyle='#fff';ctx.fillRect(0,0,PAGE_W,PAGE_H);
    ctx.fillStyle='#000';ctx.textAlign='left';ctx.textBaseline='top';

    ctx.font='bold 36px sans-serif';
    ctx.fillText('Pixel Math Worksheet',MARGIN,MARGIN);
    const ndY=MARGIN+TITLE_H;
    ctx.font='18px sans-serif';
    ctx.fillText('Name: ____________________',MARGIN,ndY);
    ctx.fillText('Date: ____________________',MARGIN+500,ndY);

    // color key
    let x=MARGIN,y=ndY+ND_H+ND_GAP+8;
    palette.forEach((col,i)=>{
      if(x+KEY_CELL_W>PAGE_W-MARGIN){x=MARGIN;y+=KEY_SWATCH+KEY_ROW_GAP;}
      ctx.fillStyle=col.hex;
      ctx.fillRect(x,y-KEY_SWATCH/2,KEY_SWATCH,KEY_SWATCH);
      ctx.strokeStyle='#000';ctx.lineWidth=1;
      ctx.strokeRect(x,y-KEY_SWATCH/2,KEY_SWATCH,KEY_SWATCH);
      ctx.fillStyle='#000';ctx.font='16px sans-serif';
      ctx.fillText(`= ${i+1}`,x+KEY_SWATCH+8,y);
      x+=KEY_CELL_W;
    });

    // problems grid
    const gridY=y+KEY_SWATCH/2+20;
    const pad=Math.max(4,Math.floor(cell*0.1));
    problems=new Array(gridW*gridH);
    const fontSize=parseInt(document.getElementById('fontScale').value,10);

    for(let r=0;r<gridH;r++){
      for(let ccol=0;ccol<gridW;ccol++){
        const idx=r*gridW+ccol;
        const palIndex=indices[idx];
        const ans=palIndex+1;
        const prob=makeProblem(ans);
        problems[idx]=prob;
        const x0=MARGIN+ccol*cell;
        const y0=gridY+r*cell;
        ctx.strokeStyle='#000';ctx.lineWidth=1;ctx.strokeRect(x0,y0,cell,cell);
        ctx.fillStyle='#000';ctx.font=`${fontSize}px sans-serif`;
        ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText(prob,x0+cell/2,y0+cell/2);
      }
    }
    return c;
  }

  function renderAnswerCanvas(){
    const PAGE_W=1800,MARGIN=60;
    const usableW=PAGE_W-2*MARGIN;
    const cell=Math.max(6,Math.floor(usableW/gridW));
    const c=document.createElement('canvas');
    c.width=PAGE_W;c.height=cell*gridH+2*MARGIN;
    const ctx=c.getContext('2d');
    ctx.fillStyle='#fff';ctx.fillRect(0,0,c.width,c.height);
    for(let r=0;r<gridH;r++){
      for(let col=0;col<gridW;col++){
        const idx=r*gridW+col;
        ctx.fillStyle=palette[indices[idx]].hex;
        ctx.fillRect(MARGIN+col*cell,MARGIN+r*cell,cell,cell);
      }
    }
    return c;
  }

  // file input
  const drop=document.getElementById('drop');
  const file=document.getElementById('file');
  drop.addEventListener('click',()=>file.click());
  function handleFiles(files){
    if(!files||!files[0])return;
    const url=URL.createObjectURL(files[0]);
    const imgNew=new Image();
    imgNew.onload=()=>{img=imgNew;imgLoaded=true;drawOrigFit();URL.revokeObjectURL(url);};
    imgNew.onerror=()=>alert('Could not load that image.');
    imgNew.src=url;
  }
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag');});
  drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
  drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('drag');handleFiles(e.dataTransfer.files);});
  file.addEventListener('change',()=>handleFiles(file.files));

  // Pixelate
  document.getElementById('btnPixelate').addEventListener('click',()=>{
    if(!imgLoaded){alert('Please upload an image first.');return;}
    sampleToGrid(parseInt(colsEl.value,10),parseInt(rowsEl.value,10));
    kmeansQuantize(parseInt(kEl.value,10));
    drawPixelatedPreview();
  });

  // Generate worksheet + answer key
  document.getElementById('btnGenerate').addEventListener('click',()=>{
    if(!cellColors.length||!palette.length||!indices.length){alert('Pixelate first.');return;}
    const wsCanvas=renderWorksheetCanvas();
    worksheetPreviewImg.src=wsCanvas.toDataURL();
    worksheetPrintImg.src=wsCanvas.toDataURL();
    const ansCanvas=renderAnswerCanvas();
    answerPreviewImg.src=ansCanvas.toDataURL();
    answerPrintImg.src=ansCanvas.toDataURL();
  });

  // Save PDF / print
  document.getElementById('btnSave').addEventListener('click',()=>window.print());
})();
</script>
</body>
</html>
